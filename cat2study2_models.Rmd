---
title: "R Notebook"
output: html_notebook
---

Start by loading dependencies and the data

```{r message=FALSE, warning=FALSE}
library(brms)
library(tidyr)
library(dplyr)
library(bayesplot)
library(tidybayes)
d  <- read_and_clean("data/cat2stduy1_data.csv") 
```


## Binomial models

First I fit a binomial model to the data. 

```{r message=FALSE, warning=FALSE}
#Well, fist, first I wrangle data
tmp <- d %>% 
  filter(condition == "xb" | condition == "mc" | condition == "ft") %>% 
  mutate(categorization = recode(categorization, 
                                 "F" = "1", "kvinna" = "1", "female" = "1", "female " = "1", "Female"= "1", "Fenale"= "1", "women" = "f", "woman " = "1", "femLE" = "1", "FEmale" = "1", "Femalw" = "1", "Fwmalw" = "1", "Female " = "1", "woman" = "1", "Woman" = "1", "feMale" = "1", "fermale" = "1", "wman" = "1", "Femae" = "1",
                                 "man" = "m","Male " = "m", "make" = "m", "Male"= "m", "male" = "m", "man " = "m",  "male " = "m", "guy" = "m", "boy" = "m", "Make" = "m", "M"  = "m", "Man" = "m", "Bottom half male; above nose female., Would have to say Male" = "m", " male" = "m", "male  " = "m", "ale" = "m", "nmale" = "m", "MALE"= "m", "nale"= "m", " Male" = "m",
                                 "Nonbinary" = "o", "Non Binary " = "o", "Unsure" = "o", "Non binary " = "o", "good" = "o", "Neutral" = "o", "neutral" = "o", "nonbinary" = "o", "bigender" = "o", "hen" = "o", "don't know"  = "o", "Bottom half male, nose upwards female" = "o" )) %>% 
  mutate(f_cat = ifelse(categorization == "1", 1, 0))
```

Then I fite a binomial logistic model with fixed effect of condition and facial masculinity and varying intercepts for faces, varying intercepts for subjects and varying intercepts for masculinity (i.e. allowing the effect of masculinity to vary for each subject).

$$
\begin{aligned}
\text{categorization}_{i} &\sim \mathrm{Binomial}(1,p) \\
\text{logit}(p_i)&= \gamma_{condition[i]}+ \alpha_{subject[i]} + \beta_{condition[i]}M+ \gamma_{face[i],condition[i]}\\
\gamma_{condition} &\sim \mathrm{Normal}(0,3),\: \text{for}\: condition =\text{ft, bc, mc}\\
\alpha_{subject} &\sim \mathrm{Normal}(0, \sigma_{subject}) \\
\beta_{condition}M & \sim \mathrm{Normal}(0,3),\: \text{for}\: pronoun =1,...,4\\
\begin{bmatrix}
\beta_{ft}\\\beta_{bc} \\\beta_{mc}
\end{bmatrix}
&\sim \mathrm{MVNormal}\Bigg(\begin{bmatrix} 0\\ 0\\ 0\end{bmatrix}, \Sigma _{face}\Bigg) \\
\Sigma_{face} & =\textbf{S}_{\beta[cid]}\textbf{R}_{\beta[cid]}\textbf{S}_{\beta[cid]}  \\
\sigma_{subject} &\sim \mathrm{HalfCauchy}(3) \\
\sigma_{\gamma_{pronoun}}&\sim \mathrm{HalfCauchy}(3) \\
\textbf{R} &\sim \mathrm{LKJcorr}(2) \\
\end{aligned}
$$

```{r}
fit_binary_index <- brm(f_cat ~ 0 + condition + masc:condition + (1 +masc|id) + (1|face), family = bernoulli(link = 'logit'), 
          prior = c(prior(normal(0,3), class = "b", coef = "conditionmc"),
                    prior(normal(0,3), class ="b", coef= "conditionmc:masc"),
                    prior(normal(0,3), class = "b", coef = "conditionxb"),
                    prior(normal(0,3), class = "b", coef = "conditionxb:masc"),
                    prior(normal(0,3), class = "b", coef = "conditionft"),
                    prior(normal(0,3), class ="b", coef= "conditionft:masc")
                    ),
          data = tmp,
          iter = 4000, warmup = 1000,
          chains = 4,
          cores = 4,
          sample_prior = TRUE,
          file = "models/fit_binary_stair_index2"
          )
```

Cool, so we fit this data and what do we find? If we just start by getting a summary.

```{r}
summary(fit_binary_index)
conditional_effects(fit_binary_index)
```

The first figures shows the "main effects" of condition and the second illustrates the the interaction, i.e. is the slope of masculnity different depending on condition. If we squint, maybe the ft slope looks a little bit shallower, but it's not very easy to tell. We can directly find the values for the differences in the slopes though using the built-in `hypothesis`function in brms. 

```{r}
hypothesis(fit_binary_index, "conditionft:masc= conditionxb:masc" )
hypothesis(fit_binary_index, "conditionf:masc= conditionmc:masc" )
hypothesis(fit_binary_index, "conditionf:masc= conditionxb:masc" )
```

## Gaussian models

```{r}
#Wrangle data
tmp <- d %>% 
  filter(condition == "sd" | condition == "md") %>% 
  mutate(f_rating = as.numeric(categorization) %>%  ifelse(scale == "f", ., 100- .),
         scale_new = ifelse(scale == "f" | scale =="m", scale, "sd"))


#Experimenting with fitting a bayesian model to the scale data
fit_dimensional_stair <- brm(f_rating ~ masc:scale_new + (1 + masc|id) + (1|face), family = gaussian(link = 'identity'), 
          prior = c(prior(normal(0,1.5), class = "b"),
                    prior(normal(50,20), class = "Intercept")),
          data = tmp,
          iter = 4000, warmup = 1000,
          cores = 4,
          sample_prior = TRUE, #necessary to analyse bayes factor
          file = "models/fit_dimensional_stair")

summary(fit_dimensional_stair)

# the "dumb" way to do it is just to calculate intercepts at each level masculinity and condition, and 
#check how similar they are.

tmp <- tmp %>% 
  mutate(masc = as.factor(masc)) 

get_prior(formula = (f_rating ~ 1 + masc:condition + (1 + masc|id) + (1|face)), family = gaussian(link = 'identity'), data = tmp)

fit_dimensional_stair_factor <- 
  brm(f_rating ~ 0 + masc:condition + (1 + masc|id) + (1|face), family = gaussian(link = 'identity'), 
          prior = c(prior(normal(50,50), class = "b"),
                    #prior(normal(50,50), class = "Intercept"),
                    prior(exponential(1), class = "sd"),
                    prior(lkj(1), class = "cor"),
                    prior(exponential(1), class = sigma)),
          data = tmp,
          iter = 4000, warmup = 1000,
          cores = 4,
          sample_prior = TRUE,
          file = "models/fit_dimensional_stair_factor")

conditional_effects(fit_dimensional_stair_factor)
```

just writing out the model

a + (b-a)/(1+e^(c-x)/d

